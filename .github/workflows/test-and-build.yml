name: Test and Build Go-Trust

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: '1.23'

jobs:
  test-go-trust:
    name: Run Go-Trust Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout docker-go-trust repository
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libxml2-dev \
          ca-certificates \
          git
          
    - name: Clone go-trust source code
      run: |
        git clone https://github.com/SUNET/go-trust.git /tmp/go-trust-source
        
    - name: Setup go-trust with controlled dependencies
      working-directory: /tmp/go-trust-source
      run: |
        # Create hybrid go.mod with our controlled dependencies
        echo 'module github.com/SUNET/go-trust' > go.mod.new
        echo '' >> go.mod.new
        echo 'go ${{ env.GO_VERSION }}' >> go.mod.new
        echo '' >> go.mod.new
        
        # Copy require blocks from our controlled dependencies if they exist
        if [ -f "${{ github.workspace }}/go.mod" ]; then
          sed -n '/^require (/,/^)/{p}' "${{ github.workspace }}/go.mod" >> go.mod.new || true
          echo '' >> go.mod.new
          # Copy replace directives
          grep '^replace ' "${{ github.workspace }}/go.mod" >> go.mod.new || true
        fi
        
        # Apply the new go.mod
        mv go.mod.new go.mod
        
        # Use our controlled go.sum if it exists
        if [ -f "${{ github.workspace }}/go.sum" ]; then
          cp "${{ github.workspace }}/go.sum" ./
        fi
        
    - name: Download dependencies
      working-directory: /tmp/go-trust-source
      run: |
        go mod tidy
        go mod download
        go mod verify
        
    - name: Run go-trust tests
      working-directory: /tmp/go-trust-source
      run: |
        echo "Running all go-trust tests..."
        go test -v ./...
        
    - name: Run go-trust tests with race detection
      working-directory: /tmp/go-trust-source
      run: |
        echo "Running go-trust tests with race detection..."
        go test -race -v ./...
        
    - name: Build go-trust binary
      working-directory: /tmp/go-trust-source
      run: |
        echo "Building go-trust binary..."
        CGO_ENABLED=1 GOOS=linux go build -a \
          -ldflags='-w -s -extldflags "-static"' \
          -o go-trust ./cmd
        
        echo "Verifying binary was created..."
        ls -la go-trust
        file go-trust

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test-go-trust
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      run: |
        docker build -t go-trust-service:test \
          --build-arg GO_TRUST_VERSION=main \
          -f Dockerfile .
          
    - name: Test Docker image
      run: |
        echo "Testing Docker image can be created successfully..."
        docker images go-trust-service:test
        
        echo "Testing Docker image runs (quick validation)..."
        # Run container in background to test it starts
        docker run -d --name test-container \
          -e SERVICE_PORT=6001 \
          -e SERVICE_HOST=0.0.0.0 \
          -e LOG_LEVEL=info \
          -e CONFIG_FILE=/etc/go-trust/config.json \
          -e PIPELINE_FILE=/app/pipeline.yaml \
          -e FREQUENCY=3600 \
          go-trust-service:test
          
        # Give it a moment to start
        sleep 5
        
        # Check if container is still running (not crashed immediately)
        if docker ps | grep test-container; then
          echo "✅ Container started successfully"
        else
          echo "❌ Container failed to start"
          docker logs test-container
          exit 1
        fi
        
        # Clean up
        docker stop test-container
        docker rm test-container

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
