name: Test Go-Trust with Controlled Dependencies

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

env:
    GO_VERSION: "1.23"

jobs:
    test-go-trust:
        name: Test Go-Trust with Docker-Go-Trust Dependencies
        runs-on: ubuntu-latest

        steps:
            - name: Checkout docker-go-trust repository
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y 
                    build-essential 
                    pkg-config 
                    libxml2-dev 
                    ca-certificates 
                    git

            - name: Clone go-trust source code
              run: |
                  git clone https://github.com/SUNET/go-trust.git /tmp/go-trust-source
                  echo "Cloned go-trust to /tmp/go-trust-source"
                  ls -la /tmp/go-trust-source

            - name: Setup go-trust with docker-go-trust controlled dependencies
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Setting up go-trust with controlled dependencies from docker-go-trust..."

                  # Create hybrid go.mod: go-trust module name + docker-go-trust controlled dependencies
                  echo 'module github.com/SUNET/go-trust' > go.mod.new
                  echo '' >> go.mod.new
                  echo 'go ${{ env.GO_VERSION }}' >> go.mod.new
                  echo '' >> go.mod.new

                  # Copy require blocks from docker-go-trust controlled dependencies if they exist
                  if [ -f "${{ github.workspace }}/go.mod" ]; then
                    echo "Found docker-go-trust go.mod, applying controlled dependencies..."
                    sed -n '/^require (/,/^)/{p}' "${{ github.workspace }}/go.mod" >> go.mod.new || true
                    echo '' >> go.mod.new
                    # Copy replace directives from docker-go-trust
                    grep '^replace ' "${{ github.workspace }}/go.mod" >> go.mod.new || true
                    echo "Applied replace directives from docker-go-trust:"
                    grep '^replace ' "${{ github.workspace }}/go.mod" || echo "No replace directives found"
                  else
                    echo "No docker-go-trust go.mod found, using go-trust defaults"
                  fi

                  # Apply the new go.mod
                  mv go.mod.new go.mod
                  echo "Generated hybrid go.mod:"
                  cat go.mod

                  # Use docker-go-trust controlled go.sum if it exists
                  if [ -f "${{ github.workspace }}/go.sum" ]; then
                    echo "Using docker-go-trust controlled go.sum"
                    cp "${{ github.workspace }}/go.sum" ./
                  else
                    echo "No docker-go-trust go.sum found, will generate new one"
                  fi

            - name: Download dependencies with controlled versions
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Downloading dependencies with docker-go-trust controlled versions..."
                  go mod tidy
                  go mod download
                  go mod verify
                  echo "Dependencies successfully downloaded and verified"

            - name: Verify go-trust test setup
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Verifying go-trust project structure for testing..."
                  echo "Current directory contents:"
                  ls -la
                  echo ""
                  echo "Go module information:"
                  go list -m
                  echo ""
                  echo "Available packages:"
                  go list ./... || echo "No packages found with ./..."
                  echo ""
                  echo "Test files found:"
                  find . -name "*_test.go" -type f | head -20
                  echo ""
                  echo "Go environment:"
                  go env GOMOD GOROOT GOPATH

            - name: Run go-trust tests (SUNET style)
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Running go-trust tests with SUNET configuration..."
                  echo "Using docker-go-trust controlled dependencies"

                  # Run tests exactly like SUNET go-trust does
                  go test -v -race -timeout 10m -coverprofile=coverage.txt -covermode=atomic ./...

                  echo "‚úÖ All go-trust tests passed with controlled dependencies!"

            - name: Process coverage results
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Processing test coverage results..."
                  if [ -f "coverage.txt" ]; then
                    echo "Generating coverage reports..."
                    go tool cover -html=coverage.txt -o coverage.html
                    echo ""
                    echo "Coverage summary:"
                    go tool cover -func=coverage.txt
                    echo ""
                    
                    # Extract total coverage percentage
                    COVERAGE=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//' || echo "0")
                    echo "üìä Total coverage: ${COVERAGE}%"
                    
                    # Create coverage badge data
                    echo "COVERAGE=${COVERAGE}" >> $GITHUB_ENV
                    echo "‚úÖ Coverage analysis completed!"
                  else
                    echo "‚ùå No coverage.txt file found"
                    exit 1
                  fi

            - name: Upload coverage reports
              uses: actions/upload-artifact@v4
              with:
                  name: go-trust-coverage-report
                  path: |
                      /tmp/go-trust-source/coverage.txt
                      /tmp/go-trust-source/coverage.html

            - name: Build go-trust binary with controlled dependencies
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Building go-trust binary with docker-go-trust controlled dependencies..."
                  CGO_ENABLED=1 GOOS=linux go build -a 
                    -ldflags='-w -s -extldflags "-static"' 
                    -o go-trust ./cmd

                  echo "Verifying binary was created successfully..."
                  ls -la go-trust
                  file go-trust
                  echo "‚úÖ go-trust binary built successfully with controlled dependencies!"

    build-docker:
        name: Build Docker Image with Tested Dependencies
        runs-on: ubuntu-latest
        needs: test-go-trust

        steps:
            - name: Checkout docker-go-trust repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              run: |
                  echo "Building Docker image with tested dependencies..."
                  docker build -t go-trust-service:test \
                    --build-arg GO_TRUST_VERSION=main \
                    -f Dockerfile .
                  echo "‚úÖ Docker image built successfully!"

            - name: Test Docker image functionality
              run: |
                  echo "Testing Docker image functionality..."
                  docker images go-trust-service:test

                  echo "Testing Docker image starts correctly..."
                  # Run container in background to test it starts
                  docker run -d --name test-container \
                    -e SERVICE_PORT=6001 \
                    -e SERVICE_HOST=0.0.0.0 \
                    -e LOG_LEVEL=info \
                    -e CONFIG_FILE=/etc/go-trust/config.json \
                    -e PIPELINE_FILE=/app/pipeline.yaml \
                    -e FREQUENCY=3600 \
                    go-trust-service:test
                    
                  # Give it time to start
                  sleep 10

                  # Check if container is still running (not crashed immediately)
                  if docker ps | grep test-container; then
                    echo "‚úÖ Container started successfully"
                    docker logs test-container
                  else
                    echo "‚ùå Container failed to start"
                    docker logs test-container
                    exit 1
                  fi

                  # Clean up
                  docker stop test-container
                  docker rm test-container
                  echo "‚úÖ Docker functionality test completed!"

    security-scan:
        name: Security Analysis
        runs-on: ubuntu-latest
        needs: build-docker

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"
