name: Test Go-Trust with Controlled Dependencies

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

env:
    GO_VERSION: "1.25"

jobs:
    test-and-coverage:
        name: Test Go-Trust and Generate Coverage
        runs-on: ubuntu-latest

        steps:
            - name: Checkout docker-go-trust repository
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.25"
                  cache: true

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential \
                    pkg-config \
                    libxslt1-dev \
                    libxml2-dev \
                    xsltproc \
                    bc \
                    ca-certificates \
                    git

            - name: Clone go-trust source code
              run: |
                  git clone https://github.com/SUNET/go-trust.git /tmp/go-trust-source
                  echo "Cloned go-trust to /tmp/go-trust-source"

            - name: Setup go-trust with controlled dependencies
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Setting up go-trust with controlled dependencies from docker-go-trust..."

                  # Create hybrid go.mod: go-trust module name + docker-go-trust controlled dependencies
                  echo 'module github.com/SUNET/go-trust' > go.mod.new
                  echo '' >> go.mod.new
                  echo 'go ${{ env.GO_VERSION }}' >> go.mod.new
                  echo '' >> go.mod.new

                  # Copy require blocks from docker-go-trust controlled dependencies if they exist
                  if [ -f "${{ github.workspace }}/go.mod" ]; then
                    echo "Found docker-go-trust go.mod, applying controlled dependencies..."
                    sed -n '/^require (/,/^)/{p}' "${{ github.workspace }}/go.mod" >> go.mod.new || true
                    echo '' >> go.mod.new
                    # Copy replace directives from docker-go-trust
                    grep '^replace ' "${{ github.workspace }}/go.mod" >> go.mod.new || true
                    echo "Applied replace directives:"
                    grep '^replace ' "${{ github.workspace }}/go.mod" || echo "No replace directives found"
                  else
                    echo "No docker-go-trust go.mod found, using go-trust defaults"
                  fi

                  # Apply the new go.mod
                  mv go.mod.new go.mod
                  echo "Generated hybrid go.mod:"
                  cat go.mod

                  # Use docker-go-trust controlled go.sum if it exists
                  if [ -f "${{ github.workspace }}/go.sum" ]; then
                    echo "Using docker-go-trust controlled go.sum"
                    cp "${{ github.workspace }}/go.sum" ./
                  fi

            - name: Download dependencies
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Downloading dependencies with controlled versions..."
                  go mod tidy
                  go mod download

            - name: Verify dependencies
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Verifying dependencies..."
                  go mod verify
                  echo "DONE Dependencies downloaded and verified"

            - name: Build
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Building all packages..."
                  go build -v ./...
                  echo "DONE Build successful"

            - name: Run tests with coverage
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Running tests with coverage (exactly like SUNET go-trust)..."
                  go test -v -race -timeout 10m -coverprofile=coverage.txt -covermode=atomic ./...

            - name: Generate coverage reports
              working-directory: /tmp/go-trust-source
              if: always() # Run even if tests failed
              run: |
                  echo "Generating coverage reports..."
                  if [ -f "coverage.txt" ]; then
                    echo "Coverage file found, processing..."
                    # Generate HTML coverage report
                    go tool cover -html=coverage.txt -o coverage.html
                    echo ""
                    echo "Coverage summary:"
                    go tool cover -func=coverage.txt
                    echo ""
                    
                    # Extract total coverage percentage
                    COVERAGE=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//' || echo "0")
                    echo "ðŸ“Š Total coverage: ${COVERAGE}%"
                    
                    # Create coverage badge data for potential future use
                    echo "COVERAGE=${COVERAGE}" >> $GITHUB_ENV
                    echo "DONE Coverage analysis completed successfully!"
                  else
                    echo "FAIL No coverage.txt file found"
                    echo "Checking working directory contents:"
                    ls -la
                    echo "Looking for any coverage files:"
                    find . -name "*coverage*" -type f || echo "No coverage files found"
                  fi

            - name: Upload coverage reports
              uses: actions/upload-artifact@v4
              if: always() # Upload even if tests failed
              with:
                  name: go-trust-coverage-report
                  path: |
                      /tmp/go-trust-source/coverage.txt
                      /tmp/go-trust-source/coverage.html

            - name: Display test results summary
              run: |
                  echo "DONE Test and Coverage Summary:"
                  echo "DONE All go-trust tests passed"
                  echo "DONE Coverage report generated"
                  echo "DONE Using docker-go-trust controlled dependencies"
                  echo "DONE Coverage: ${COVERAGE}%"
